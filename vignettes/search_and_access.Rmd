---
title: "Search and Access Data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Search and Access Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(EDIutils)
```

### Search and Access Data

#### Search

The repository search service is a standard deployment of Apache Solr and indexes select metadata fields of data package metadata. For a list of searchable fields see `search_data_packages()`. See the [Apache Solr Wiki](https://cwiki.apache.org/confluence/display/solr/) for more on constructing Solr queries. For a browser based search experience, use the [EDI data portal](https://portal.edirepository.org/nis/advancedSearch.jsp) of the EDI data portal.

```{r eval=FALSE}
# List data packages containing the term "water temperature"
res <- search_data_packages(query = 'q="water+temperature"&fl=*')
res
#> {xml_document}
#> <resultset numFound="768" start="0" rows="10">
#>  [1] <document>\n  <abstract>This data set contains water leve ...
#>  [2] <document>\n  <abstract>This data set contains water leve ...
#>  [3] <document>\n  <abstract>The second instrumented buoy on S ...
#>  [4] <document>\n  <abstract>Water temperature was measured on ...
#>  [5] <document>\n  <abstract>Profiles of water and sediment te ...
#>  [6] <document>\n  <abstract>Time series at 5 minute intervals ...
#>  [7] <document>\n  <abstract>Time series at 5 minute intervals ...
#>  [8] <document>\n  <abstract>Time series at 5 minute intervals ...
#>  [9] <document>\n  <abstract>As part of the Long Term Ecologic ...
#> [10] <document>\n  <abstract>Year 2016, continuous measurement ...
```

Results can be filtered to include only fields of interest.

```{r eval=FALSE}
# Search for data packages containing the term "water temperature" and returning 
# only the packageid, title, and score of each match
search_data_packages(query = 'q="water+temperature"&fl=packageid,title,score')
```

When constructing a query note that the 15403 data packages of the [ecotrends](https://lternet.edu/the-ecotrends-project/) project and 10492 data packages of the [LTER Landsat](https://lternet.edu/lter-remote-sensing-and-geographic-information-system-data/) project, can be excluded from the returned results by including `&fq=-scope:(ecotrends+lter-landsat)` in the query string.

```{r eval=FALSE}
# Search for data packages containing the term "water temperature", returning 
# only the packageid, title, score, and excluding ecotrends and lter-landsat 
# scopes from the returned results
query <- 'q="water+temperature"&fl=packageid,title,score&fq=-scope:(ecotrends+lter-landsat)'
search_data_packages(query)
```

#### Access

Data entities are downloaded in raw bytes and parsed by a reader function.

```{r eval=FALSE}
# List data entities of data package edi.1047.1
res <- read_data_entity_names(packageId = "edi.1047.1")
res
#>                           entityId                entityName
#> 1 3abac5f99ecc1585879178a355176f6d        Environmentals.csv
#> 2 f6bfa89b48ced8292840e53567cbf0c8               ByCatch.csv
#> 3 c75642ddccb4301327b4b1a86bdee906               Chinook.csv
#> 4 2c9ee86cc3f3ffc729c5f18bfe0a2a1d             Steelhead.csv
#> 5 785690848dd20f4910637250cdc96819 TrapEfficiencyRelease.csv
#> 6 58b9000439a5671ea7fe13212e889ba5 TrapEfficiencySummary.csv
#> 7 86e61c1a501b7dcf0040d10e009bfd87        TrapOperations.csv

# Read raw bytes of Steelhead.csv
raw <- read_data_entity(packageId = "edi.1047.1", entityId = res$entityId[4])
head(raw)
#> [1] ef bb bf 44 61 74

# Parse with .csv reader
data <- readr::read_csv(file = raw)
data
#> # A tibble: 2,926 x 14
#>    Date   trapVisitID subSiteName catchRawID releaseID commonName 
#>    <chr>        <dbl> <chr>            <dbl>     <dbl> <chr>      
#>  1 1/12/~         326 North Chan~      32123         0 Steelhead ~
#>  2 1/14/~         336 North Chan~      33980         0 Steelhead ~
#>  3 1/15/~         337 North Chan~      32683         0 Steelhead ~
#>  4 1/16/~         339 North Chan~      32971         0 Steelhead ~
#>  5 1/17/~         341 North Chan~      33104         0 Steelhead ~
#>  6 1/18/~         342 North Chan~      33304         0 Steelhead ~
#>  7 1/19/~         343 North Chan~      33432         0 Steelhead ~
#>  8 1/21/~         349 North Chan~      34083         0 Steelhead ~
#>  9 1/21/~         349 North Chan~      34084         0 Steelhead ~
#> 10 1/23/~         351 North Chan~      34384         0 Steelhead ~
#> # ... with 2,916 more rows, and 8 more variables:
#> #   lifeStage <chr>, forkLength <dbl>, weight <dbl>, n <dbl>,
#> #   mort <chr>, fishOrigin <chr>, markType <chr>,
#> #   CatchRaw.comments <chr>
```

